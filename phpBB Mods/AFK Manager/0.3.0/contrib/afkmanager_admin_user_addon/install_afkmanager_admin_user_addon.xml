<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="./modx.prosilver.en.xsl" ?>
<!--
	NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.
-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
<header>
	<meta name="generator" content="MODX file generated with PP MODX Creator by tumba25" />
	<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
	<title lang="en">AFK Manager Mod Addon - Admin User ACP</title>
	<description lang="en">Addon for the AFK Manager Mod that adds a new page to the User administration form called AFK Manager. This allows the administrator to set the users AFK status from within the ACP.</description>
	<author-notes lang="en">Requires the AFK Manager Mod to be installed previously.</author-notes>
	<author-group>
		<author>
			<realname>-[Nwo]- fearless</realname>
			<username>-[Nwo]- fearless</username>
			<homepage>www.NewWorldOrder.org.uk</homepage>
			<email>fearless@newworldorder.org.uk</email>
		</author>
	</author-group>
	<mod-version>0.3.0</mod-version>
	<installation>
		<level>easy</level>
		<time>300</time>
		<target-version>3.0.5</target-version>
	</installation>
	<link-group>
		<link type="dependency" href="http://www.NewWorldOrder.org.uk/downloads/AFK_Manager_Mod.zip" lang="en">AFK Manager Mod</link>
	</link-group>
</header>
<action-group>
	<sql dbms="mysql_41"><![CDATA[INSERT INTO phpbb_modules SET module_enabled = "1", module_display = "0", module_basename = "users", module_class = "acp", parent_id = "13", left_id = "135", right_id = "136", module_langname = "ACP_AFKMANAGER", module_mode = "afkmanager", module_auth = "acl_a_user";]]></sql>
	<copy>
		<file from="adm/style/acp_users_afkmanager.html" to="adm/style/acp_users_afkmanager.html" />
	</copy>
	<open src="adm/style/acp_users.html">
		<edit>
			<find><![CDATA[	<!-- INCLUDE permission_mask.html -->]]></find>
			<action type="after-add"><![CDATA[<!-- ELSEIF S_AFKMANAGER -->

<!-- INCLUDE acp_users_afkmanager.html -->]]></action>
		</edit>
	</open>
	<open src="includes/acp/acp_afkmanager.php">
		<edit>
			<comment lang="en"><![CDATA[Optional edit to allow you to click on the user link in the AFK User List and go straight to the User administration AFK Manager page, which allows you to set their AFK status manually. To set the AFK status of any other forum user, you can goto ACP->Users & Groups->Manage User->Find A Member->AFK Manager in the dropdown box and change AFK settings.]]></comment>
			<find><![CDATA[						'AFKER_LINK'			=> append_sid('../memberlist.php?mode=viewprofile&u=' . $row['user_id']),]]></find>
			<action type="replace-with"><![CDATA[						'AFKER_LINK'			=> append_sid('../adm/index.php?i=users&icat=13&mode=afkmanager&u=' . $row['user_id']),	]]></action>
		</edit>
	</open>
	<open src="includes/acp/acp_users.php">
		<edit>
			<find><![CDATA[				$template->assign_vars(array(
					'S_PERMISSIONS'				=> true,

					'S_GLOBAL'					=> (!$forum_id) ? true : false,
					'S_FORUM_OPTIONS'			=> $s_forum_options,

					'U_ACTION'					=> $this->u_action . '&amp;u=' . $user_id,
					'U_USER_PERMISSIONS'		=> append_sid("{$phpbb_admin_path}index.$phpEx" ,'i=permissions&amp;mode=setting_user_global&amp;user_id[]=' . $user_id),
					'U_USER_FORUM_PERMISSIONS'	=> append_sid("{$phpbb_admin_path}index.$phpEx", 'i=permissions&amp;mode=setting_user_local&amp;user_id[]=' . $user_id))
				);

			break;]]></find>
			<action type="after-add"><![CDATA[			// AFK Manager Mod
			case 'afkmanager':
				
				// Add our language file
				$user->add_lang(array('mods/afkmanager'));

				// Retrieve vars from form or from user table current row and set some vars ourself		
				$afkstatus = request_var('afkstatus', $user_row['user_afkstatus']);
				$afkdate = date('Y-m-d H:i:s');
				$afkpmmsg = '';
				$afktopicid = 0;
				$afkreasoncategory = request_var('afkreasoncategoryselect', $user_row['user_afkreasoncat']);
				
				$data = array(
					'afkstatus'			=> $afkstatus,
					'afkdate'			=> $afkdate,
					'afkpmmsg'			=> $afkpmmsg,
					'afktopicid'		=> $afktopicid,
					'afkreasoncategory' => $afkreasoncategory,
				);
				
				// Create the array of afk reasons. ToDo: SQL Table to replace array?
				$afkreasoncategoriesarray = array(
					'0'		=>	' ', 
					'1'		=>	'Holiday', 
					'2'		=>	'School/College/University', 
					'3'		=>	'Illness',
					'4'		=>	'Family Matter',
					'5'		=>	'Real Life Issues', 
					'6'		=>	'Work/Training', 
					'7'		=>	'Party/Celebration',
					'8'		=>	'Night Out/Social Event',
					'9'		=>	'Marriage/Engagement',
					'10'	=>	'Internet/Computer Problem',
					'11'	=>	'Inactive',			
				);					
				
				if ($submit)
				{
					if (!check_form_key($form_name))
					{
						trigger_error($user->lang['FORM_INVALID'] . adm_back_link($this->u_action . '&amp;u=' . $user_id), E_USER_WARNING);
					}

					$sql_ary = array(
						'user_afkstatus'	=> $data['afkstatus'],
						'user_afkdate'		=> $data['afkdate'],
						'user_afkpmmsg'		=> $data['afkpmmsg'],
						'user_afktopicid'	=> $data['afktopicid'],
						'user_afkreasoncat'	=> $data['afkreasoncategory'],
					);
						
					$sql = 'UPDATE ' . USERS_TABLE . '
						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "
						WHERE user_id = $user_id";
					$db->sql_query($sql);
					
					add_log('admin', 'LOG_ADMIN_AFK_STATUS', $afkstatus ? 'AFK' : 'Not AFK', $user->data['username']);

					trigger_error($user->lang['ACP_USER_AFKSTATUS_UPDATED'] . adm_back_link($this->u_action . '&amp;u=' . $user_id));
				}

				// Build afk reasons select options
				$afkreasons_options = '';
				foreach ($afkreasoncategoriesarray as $field=>$value) 
				{
					if ($field == $afkreasoncategory)
					{
						$afkreasons_options .= '<option selected value="' . $field . '">' . $value . '</option>\n';
					}
					else
					{
						$afkreasons_options .= '<option value="' . $field . '">' . $value . '</option>\n';
					}
				}				

				$template->assign_vars(array(
					'S_AFKMANAGER'			=> true,
					'AFKSTATUS'				=> $afkstatus,
					'AFKREASONCATEGROIES'	=> $afkreasons_options,
				));

			break;
			// AFK Manager Mod]]></action>
		</edit>
	</open>
	<open src="language/en/acp/common.php">
		<edit>
			<comment lang="en"><![CDATA[This edit is required to allow log entries in the admin ACP when an admin changes a users AFK status]]></comment>
			<find><![CDATA[));

?>]]></find>
			<action type="before-add"><![CDATA[	
	// AFK Manager Mod Addon - Admin User ACP
	'LOG_ADMIN_AFK_STATUS'		=> '<strong>Admin changed users AFK status to: %1$s</strong><br />Â» %2$s',
	// AFK Manager Mod Addon - Admin User ACP]]></action>
		</edit>
	</open>
	<diy-instructions lang="en">1. Install AFK Manager Mod and follow instructions.
2. Execute the SQL statement in phpMyAdmin or a similar tool.
3. Copy over files.
4. Make the required edits.
5. Purge Cache.</diy-instructions>
</action-group>
</mod>
